{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "description": "Creates a Windows Server VM with SQL Server 2019 Developer Edition pre-installed for the Performance Tuning lab"
  },
  "parameters": {
    "adminUsername": {
      "type": "string",
      "defaultValue": "cloud_user",
      "minLength": 1,
      "metadata": {
        "description": "Username for the Virtual Machine administrator account"
      }
    },
    "adminPassword": {
      "type": "string",
      "defaultValue": "ChangeM3!Lab2025",
      "minLength": 12,
      "maxLength": 123,
      "metadata": {
        "description": "Password for the VM. Default: ChangeM3!Lab2025. Must be 12-123 characters, with uppercase, lowercase, number and special character."
      }
    },
    "vmSize": {
      "type": "string",
      "defaultValue": "Standard_D2s_v3",
      "allowedValues": [
        "Standard_D2s_v3",
        "Standard_D4s_v3",
        "Standard_B2ms",
        "Standard_B4ms"
      ],
      "metadata": {
        "description": "Size of the SQL Server virtual machine"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Location for all resources"
      }
    }
  },
  "variables": {
    "vmName": "sqlLabVM",
    "vnetName": "labVnet",
    "vnetAddressPrefix": "10.0.0.0/16",
    "subnetName": "labSubnet",
    "subnetAddressPrefix": "10.0.0.0/24",
    "publicIpName": "labPublicIp",
    "publicIpDnsLabel": "[concat('sqllab-', uniqueString(resourceGroup().id))]",
    "nsgName": "labNsg",
    "nicName": "labNic",
    "storageAccountType": "Standard_LRS",
    "sqlConnectivityType": "Local",
    "sqlPortNumber": 1433,
    "sqlStorageWorkloadType": "GENERAL"
  },
  "resources": [
    {
      "type": "Microsoft.Network/networkSecurityGroups",
      "apiVersion": "2022-07-01",
      "name": "[variables('nsgName')]",
      "location": "[parameters('location')]",
      "properties": {
        "securityRules": [
          {
            "name": "RDP",
            "properties": {
              "priority": 100,
              "protocol": "Tcp",
              "access": "Allow",
              "direction": "Inbound",
              "sourceAddressPrefix": "*",
              "sourcePortRange": "*",
              "destinationAddressPrefix": "*",
              "destinationPortRange": "3389"
            }
          }
        ]
      }
    },
    {
      "type": "Microsoft.Network/publicIPAddresses",
      "apiVersion": "2022-07-01",
      "name": "[variables('publicIpName')]",
      "location": "[parameters('location')]",
      "sku": {
        "name": "Basic"
      },
      "properties": {
        "publicIPAllocationMethod": "Static",
        "publicIPAddressVersion": "IPv4",
        "dnsSettings": {
          "domainNameLabel": "[variables('publicIpDnsLabel')]"
        }
      }
    },
    {
      "type": "Microsoft.Network/virtualNetworks",
      "apiVersion": "2022-07-01",
      "name": "[variables('vnetName')]",
      "location": "[parameters('location')]",
      "properties": {
        "addressSpace": {
          "addressPrefixes": [
            "[variables('vnetAddressPrefix')]"
          ]
        },
        "subnets": [
          {
            "name": "[variables('subnetName')]",
            "properties": {
              "addressPrefix": "[variables('subnetAddressPrefix')]",
              "networkSecurityGroup": {
                "id": "[resourceId('Microsoft.Network/networkSecurityGroups', variables('nsgName'))]"
              }
            }
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.Network/networkSecurityGroups', variables('nsgName'))]"
      ]
    },
    {
      "type": "Microsoft.Network/networkInterfaces",
      "apiVersion": "2022-07-01",
      "name": "[variables('nicName')]",
      "location": "[parameters('location')]",
      "properties": {
        "ipConfigurations": [
          {
            "name": "ipconfig1",
            "properties": {
              "privateIPAllocationMethod": "Dynamic",
              "publicIPAddress": {
                "id": "[resourceId('Microsoft.Network/publicIPAddresses', variables('publicIpName'))]"
              },
              "subnet": {
                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', variables('vnetName'), variables('subnetName'))]"
              }
            }
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.Network/publicIPAddresses', variables('publicIpName'))]",
        "[resourceId('Microsoft.Network/virtualNetworks', variables('vnetName'))]"
      ]
    },
    {
      "type": "Microsoft.Compute/virtualMachines",
      "apiVersion": "2022-11-01",
      "name": "[variables('vmName')]",
      "location": "[parameters('location')]",
      "properties": {
        "hardwareProfile": {
          "vmSize": "[parameters('vmSize')]"
        },
        "osProfile": {
          "computerName": "[variables('vmName')]",
          "adminUsername": "[parameters('adminUsername')]",
          "adminPassword": "[parameters('adminPassword')]",
          "windowsConfiguration": {
            "provisionVMAgent": true,
            "enableAutomaticUpdates": false,
            "patchSettings": {
              "patchMode": "Manual"
            }
          }
        },
        "storageProfile": {
          "imageReference": {
            "publisher": "MicrosoftSQLServer",
            "offer": "sql2019-ws2022",
            "sku": "sqldev-gen2",
            "version": "latest"
          },
          "osDisk": {
            "name": "[concat(variables('vmName'), '-osdisk')]",
            "caching": "ReadWrite",
            "createOption": "FromImage",
            "managedDisk": {
              "storageAccountType": "[variables('storageAccountType')]"
            },
            "diskSizeGB": 127
          },
          "dataDisks": [
            {
              "name": "[concat(variables('vmName'), '-datadisk1')]",
              "caching": "ReadOnly",
              "createOption": "Empty",
              "diskSizeGB": 64,
              "lun": 0,
              "managedDisk": {
                "storageAccountType": "[variables('storageAccountType')]"
              }
            }
          ]
        },
        "networkProfile": {
          "networkInterfaces": [
            {
              "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('nicName'))]"
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Network/networkInterfaces', variables('nicName'))]"
      ]
    },
    {
      "type": "Microsoft.SqlVirtualMachine/sqlVirtualMachines",
      "apiVersion": "2022-07-01-preview",
      "name": "[variables('vmName')]",
      "location": "[parameters('location')]",
      "properties": {
        "virtualMachineResourceId": "[resourceId('Microsoft.Compute/virtualMachines', variables('vmName'))]",
        "sqlManagement": "Full",
        "sqlServerLicenseType": "PAYG",
        "storageConfigurationSettings": {
          "diskConfigurationType": "NEW",
          "storageWorkloadType": "[variables('sqlStorageWorkloadType')]",
          "sqlDataSettings": {
            "luns": [0],
            "defaultFilePath": "F:\\SQLData"
          },
          "sqlLogSettings": {
            "luns": [0],
            "defaultFilePath": "F:\\SQLLog"
          },
          "sqlTempDbSettings": {
            "defaultFilePath": "F:\\SQLTemp"
          }
        },
        "serverConfigurationsManagementSettings": {
          "sqlConnectivityUpdateSettings": {
            "connectivityType": "[variables('sqlConnectivityType')]",
            "port": "[variables('sqlPortNumber')]"
          },
          "additionalFeaturesServerConfigurations": {
            "isRServicesEnabled": false
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Compute/virtualMachines', variables('vmName'))]"
      ]
    },
    {
      "type": "Microsoft.Compute/virtualMachines/extensions",
      "apiVersion": "2022-11-01",
      "name": "[concat(variables('vmName'), '/CustomScriptExtension')]",
      "location": "[parameters('location')]",
      "properties": {
        "publisher": "Microsoft.Compute",
        "type": "CustomScriptExtension",
        "typeHandlerVersion": "1.10",
        "autoUpgradeMinorVersion": true,
        "settings": {
          "fileUris": [
            "https://raw.githubusercontent.com/ps-interactive/lab_performance-tuning-and-automated-maintenance/main/setup.ps1"
          ]
        },
        "protectedSettings": {
          "commandToExecute": "powershell -ExecutionPolicy Bypass -File setup.ps1"
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.SqlVirtualMachine/sqlVirtualMachines', variables('vmName'))]"
      ]
    }
  ],
  "outputs": {
    "vmName": {
      "type": "string",
      "value": "[variables('vmName')]"
    },
    "publicIPAddress": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Network/publicIPAddresses', variables('publicIpName'))).ipAddress]"
    },
    "publicDNSName": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Network/publicIPAddresses', variables('publicIpName'))).dnsSettings.fqdn]"
    },
    "rdpCommand": {
      "type": "string",
      "value": "[concat('mstsc /v:', reference(resourceId('Microsoft.Network/publicIPAddresses', variables('publicIpName'))).ipAddress, ':3389')]"
    },
    "adminUsername": {
      "type": "string",
      "value": "[parameters('adminUsername')]"
    },
    "sqlServerName": {
      "type": "string",
      "value": "[variables('vmName')]"
    },
    "labInstructions": {
      "type": "string",
      "value": "Connect via RDP, open SSMS from desktop, connect to '.' or 'localhost', then run C:\\LabScripts\\00-Setup-Lab.sql"
    }
  }
}
